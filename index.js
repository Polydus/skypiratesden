var trophiesDefault = { "trophies": [
{"trophyId":0,"trophyHidden":false,"trophyType":"platinum","trophyName":"Champion of Ivalice","trophyDetail":"Collected all other trophies.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/13D0A5AD8E4769B1520174B2521D7B632EC95AD8.PNG","trophyRare":0,"trophyEarnedRate":"0.6","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-05T16:40:29Z"}},{"trophyId":1,"trophyHidden":false,"trophyType":"bronze","trophyName":"Assault Striker","trophyDetail":"Used Attack 300 times.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/628901071A6EDA90A6385C2526300DFA6F25C74F.PNG","trophyRare":3,"trophyEarnedRate":"83.4","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T14:18:41Z"}},{"trophyId":2,"trophyHidden":false,"trophyType":"bronze","trophyName":"Spellslinger","trophyDetail":"Cast Magicks 200 times.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/FEAB9B5F71696A804760EE2AF34732418DC3F98E.PNG","trophyRare":3,"trophyEarnedRate":"64.4","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T20:25:13Z"}},{"trophyId":3,"trophyHidden":false,"trophyType":"bronze","trophyName":"Premier Prestidigitator","trophyDetail":"Used Technicks 100 times.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/EA043A49E4B4EAF7335117DCBA738D00DEE47315.PNG","trophyRare":3,"trophyEarnedRate":"53.4","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T17:05:28Z"}},{"trophyId":4,"trophyHidden":false,"trophyType":"bronze","trophyName":"Master Thief","trophyDetail":"Successfully stole 50 times.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/FA01DB01BF2BCB60CA92167B53C5CC67918CDA13.PNG","trophyRare":2,"trophyEarnedRate":"39.8","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T17:06:54Z"}},{"trophyId":5,"trophyHidden":false,"trophyType":"bronze","trophyName":"Blood Dancer","trophyDetail":"Defeated 500 foes.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/301091984E28E0C6EB3882594BBB3FA8849D8697.PNG","trophyRare":3,"trophyEarnedRate":"67.0","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T21:52:06Z"}},{"trophyId":6,"trophyHidden":false,"trophyType":"bronze","trophyName":"The Unrelenting","trophyDetail":"Completed a 50-chain in battle.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/2583D49482F43269E2629BF76A934766E2691AA3.PNG","trophyRare":2,"trophyEarnedRate":"49.8","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-14T16:51:06Z"}},{"trophyId":7,"trophyHidden":false,"trophyType":"bronze","trophyName":"Wayfarer","trophyDetail":"Took 50,000 steps.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/3D8EED6E1FDACE64DE4C06854407AE59CCAC452E.PNG","trophyRare":3,"trophyEarnedRate":"67.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-09T09:25:45Z"}},{"trophyId":8,"trophyHidden":false,"trophyType":"bronze","trophyName":"Plunderer","trophyDetail":"Acquired 100,000 gil.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/29AC13AA371CF198A35F1BE099E2F53AC70E0EDD.PNG","trophyRare":3,"trophyEarnedRate":"53.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-09T17:20:57Z"}},{"trophyId":9,"trophyHidden":false,"trophyType":"bronze","trophyName":"Record Breaker","trophyDetail":"Obtained 500,000 Clan Points.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/89655AF1E011464CD704289CFF4D62077D39A9B9.PNG","trophyRare":2,"trophyEarnedRate":"32.1","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-16T15:05:29Z"}},{"trophyId":10,"trophyHidden":false,"trophyType":"bronze","trophyName":"Spendthrift","trophyDetail":"Spent 1,000,000 gil.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/F22CA1A546D3865021719129120931975E8C0068.PNG","trophyRare":1,"trophyEarnedRate":"13.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-30T10:58:19Z"}},{"trophyId":11,"trophyHidden":false,"trophyType":"bronze","trophyName":"Privateer","trophyDetail":"Sold 1,000 pieces of loot.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/761630D0BBFE9114EDEB3DF5315C40E78A3C5D1F.PNG","trophyRare":2,"trophyEarnedRate":"42.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-16T10:54:33Z"}},{"trophyId":12,"trophyHidden":false,"trophyType":"bronze","trophyName":"Exemplar","trophyDetail":"Raised your party's average level above 50.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/76098C259D7BC5C9A4CAA94635192E59EECDB703.PNG","trophyRare":1,"trophyEarnedRate":"14.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-27T20:39:35Z"}},{"trophyId":13,"trophyHidden":false,"trophyType":"bronze","trophyName":"Conqueror","trophyDetail":"Earned 48,000 License Points.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/123628005AD0C703BF8CB0F9B99999E4C83206B5.PNG","trophyRare":2,"trophyEarnedRate":"15.3","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-28T16:17:26Z"}},{"trophyId":14,"trophyHidden":false,"trophyType":"silver","trophyName":"Scrivener","trophyDetail":"Completed the Bestiary.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/245D5664E9BAEEF1DD5903BD6E931C8A44C8EF9C.PNG","trophyRare":0,"trophyEarnedRate":"0.8","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-05T16:40:29Z"}},{"trophyId":15,"trophyHidden":false,"trophyType":"silver","trophyName":"Runeweaver","trophyDetail":"Learned every Magick.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/0913627CC04E7E0DA4071031600A00B17FE624EA.PNG","trophyRare":0,"trophyEarnedRate":"2.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T12:01:22Z"}},{"trophyId":16,"trophyHidden":false,"trophyType":"silver","trophyName":"Jack-of-All-Trades","trophyDetail":"Learned every Technick.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/49B37B74948A622B05519690B965C54E6B85F39D.PNG","trophyRare":0,"trophyEarnedRate":"2.1","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T10:54:00Z"}},{"trophyId":17,"trophyHidden":false,"trophyType":"bronze","trophyName":"Collector","trophyDetail":"Obtained a Morbid Urn.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/A6E407CC6F7E1B5B42FEDE442CE9EF45C63178C4.PNG","trophyRare":1,"trophyEarnedRate":"9.6","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-21T19:33:55Z"}},{"trophyId":18,"trophyHidden":false,"trophyType":"silver","trophyName":"Cartographer","trophyDetail":"Fully explored every map.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/342371C2812D69D4926DA4FB1C380C3DFE9D3126.PNG","trophyRare":0,"trophyEarnedRate":"1.5","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T20:25:42Z"}},{"trophyId":19,"trophyHidden":false,"trophyType":"gold","trophyName":"Mist Walker","trophyDetail":"Performed every Concurrence.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/03EF45CD1CE1F66EF6310D48190BA3DF38A1E4C6.PNG","trophyRare":0,"trophyEarnedRate":"2.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-15T19:05:05Z"}},{"trophyId":20,"trophyHidden":false,"trophyType":"bronze","trophyName":"Eagle Eye","trophyDetail":"Defeated Deathgaze.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/CB257D5950ECC797875ED4C91D6605F84BE46E0E.PNG","trophyRare":1,"trophyEarnedRate":"7.8","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-30T12:32:05Z"}},{"trophyId":21,"trophyHidden":false,"trophyType":"bronze","trophyName":"Wyrmslayer","trophyDetail":"Defeated Fafnir.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/4E8A254812508B2C765EA67EF69F7BB31DD987D5.PNG","trophyRare":1,"trophyEarnedRate":"6.0","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-30T15:22:47Z"}},{"trophyId":22,"trophyHidden":false,"trophyType":"bronze","trophyName":"Sharpshooter","trophyDetail":"Defeated the Trickster.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/C5DCD707CEC9AF311858E094FC050BD665E1E69F.PNG","trophyRare":2,"trophyEarnedRate":"17.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-16T19:11:59Z"}},{"trophyId":23,"trophyHidden":false,"trophyType":"bronze","trophyName":"Freshmaker","trophyDetail":"Defeated Carrot.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/7C3A3D8EF4831B98404396F8AF8866467AACEF44.PNG","trophyRare":1,"trophyEarnedRate":"12.1","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-30T12:47:06Z"}},{"trophyId":24,"trophyHidden":false,"trophyType":"silver","trophyName":"Master Swordsman","trophyDetail":"Defeated Gilgamesh.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/4DEB177C5FF8A876056F57EA540D5C2CE6E4C835.PNG","trophyRare":1,"trophyEarnedRate":"7.4","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-28T17:58:07Z"}},{"trophyId":25,"trophyHidden":false,"trophyType":"silver","trophyName":"Lord of the Kings","trophyDetail":"Defeated the Behemoth King.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/BF20A9C3BEF2D9579CB5E19AB828965202512174.PNG","trophyRare":0,"trophyEarnedRate":"4.4","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-03T18:48:20Z"}},{"trophyId":26,"trophyHidden":false,"trophyType":"gold","trophyName":"Hunter Extraordinaire","trophyDetail":"Defeated Yiazmat.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/1E0D6F949ADE21566A02EF1FA7D769BC83F78536.PNG","trophyRare":0,"trophyEarnedRate":"1.9","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T17:32:02Z"}},{"trophyId":27,"trophyHidden":false,"trophyType":"silver","trophyName":"Radiant Savior","trophyDetail":"Defeated the Hell Wyrm.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/CFB2610902FCB393E3FDD2FB3ACC7215B9BF933B.PNG","trophyRare":0,"trophyEarnedRate":"3.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T14:32:58Z"}},{"trophyId":28,"trophyHidden":false,"trophyType":"silver","trophyName":"Fell Angel","trophyDetail":"Defeated Ultima.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/9167AED70ABC3499FBCCCA9A3659F0BBE95C8CB2.PNG","trophyRare":1,"trophyEarnedRate":"5.9","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-29T16:41:25Z"}},{"trophyId":29,"trophyHidden":false,"trophyType":"silver","trophyName":"Zodiac Knight","trophyDetail":"Defeated Zodiark.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/B2807637A01E17E9CB0B5D9E276FC081447889D2.PNG","trophyRare":0,"trophyEarnedRate":"3.6","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-03T17:21:58Z"}},{"trophyId":30,"trophyHidden":false,"trophyType":"gold","trophyName":"High Summoner","trophyDetail":"Obtained every Esper.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/97ACE7D3E0BC7944D37D10389EA3D30EE502E0FC.PNG","trophyRare":0,"trophyEarnedRate":"3.1","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T08:56:41Z"}},{"trophyId":31,"trophyHidden":true,"trophyRare":3,"trophyEarnedRate":"96.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T12:19:13Z"}},{"trophyId":32,"trophyHidden":true,"trophyRare":3,"trophyEarnedRate":"92.2","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T12:49:44Z"}},{"trophyId":33,"trophyHidden":true,"trophyRare":3,"trophyEarnedRate":"75.0","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T18:25:50Z"}},{"trophyId":34,"trophyHidden":true,"trophyRare":3,"trophyEarnedRate":"66.9","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-07T20:37:27Z"}},{"trophyId":35,"trophyHidden":true,"trophyRare":3,"trophyEarnedRate":"56.3","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-09T12:41:37Z"}},{"trophyId":36,"trophyHidden":true,"trophyRare":2,"trophyEarnedRate":"38.7","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-11T21:07:53Z"}},{"trophyId":37,"trophyHidden":true,"trophyRare":2,"trophyEarnedRate":"26.5","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-16T18:21:10Z"}},{"trophyId":38,"trophyHidden":true,"trophyRare":1,"trophyEarnedRate":"7.9","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T20:56:46Z"}},{"trophyId":39,"trophyHidden":false,"trophyType":"bronze","trophyName":"Judge Magister","trophyDetail":"Completed the 50th trial.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/FB2D5F2E8738C96128F76F4833C630B200B472D8.PNG","trophyRare":1,"trophyEarnedRate":"6.0","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-07-30T11:41:05Z"}},{"trophyId":40,"trophyHidden":false,"trophyType":"gold","trophyName":"Imperator","trophyDetail":"Completed the 100th trial.","trophyIconUrl":"http://trophy01.np.community.playstation.net/trophy/np/NPWR11367_00_00DC6788ADDA02CC1788CFE22C61B83EF652E099A4/6C18B5A63ED70FEEB7FB330362BA3EA6A19A156C.PNG","trophyRare":0,"trophyEarnedRate":"0.9","comparedUser":{"onlineId":"undefined","earned":false,"earnedDate":"2017-08-04T20:01:10Z"}}
]};

function getRandomInt(min, max) {
    var min = Math.ceil(min);
    var max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

var express = require('express');
var gumerPSN = require(__dirname + '/lib/psn.js');
var app = express();

var zodiacId = 'NPWR11367_00';
var accounts = [];
var trophiesData = trophiesDefault;
var playerName = null;

app.set('port', (process.env.PORT || 8080));
app.use(express.static(__dirname + '/public'));
app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');

for(var i = 0; i < parseInt(process.env.ACC_AMOUNT); i++){
  accounts.push({
      email: process.env['ACC_' + i + '_EMAIL'],
      pass: process.env['ACC_' + i + '_PASS']
  });
}

//OFC this won't work if you don't add the env file!
//add an env file with valid PSN accounts for this to work
var account = accounts[getRandomInt(0, accounts.length - 1)];

gumerPSN.init({	
	debug:		false			
	,email:		account.email	
	,password:	account.pass
	,npLanguage:	'en'	
	,region: 		'us'
});

app.get('/', function(request, response) {
  response.render('pages/index', {
      trophies: trophiesData.trophies,
      playerName: playerName
  });
});

app.post('/', function (req, res) {
  try{
    gumerPSN.getGameTrophies(req.body.psn, zodiacId, '', function(error, trophyData){
      if (!error) {
        try{
          playerName = trophyData.trophies[0].comparedUser.onlineId;
          trophiesData = trophyData;
        }catch(e){
          console.error('err: couldn\'t load player name');
        }
      } else {
        console.error("error loading trophies!");
        trophiesData = trophiesDefault;
        playerName = null;
      }
    });
  }catch(e){
    console.error("error w/ psn callback");
    trophiesData = trophiesDefault;
    playerName = null;
  }
  
  res.render('pages/index', {
    trophies: trophiesData.trophies,
    playerName: playerName
  });
});

app.listen(app.get('port'), function() {
});
